#! /bin/bash

cd /app

echo "">states
echo "">relations
echo "">state-funcs
echo "">state-diagram.dot


cat pkg/game/state_functions.go |grep -A2 "Trigger States:"| \
    sed "s/() {//g"|sed "s/^func //g"|sed "s/^\\/\\/ [RT].*: //g"| \
    sed "s/,//g"|egrep -v "\-\-" |tac | \
while mapfile -t -n3 fnc && ((${#fnc[@]}));do
    # states contains multiple trigger and resulting states - we want to de-dupe these before
    # we describe their properties
    echo ${fnc[1]} ${fnc[2]}>> states

    # relations holds the mapping of nodes
    echo -e "    ${fnc[0]} [shape="'"'"box"'"'"]" >> state-funcs
    echo -e "    {" ${fnc[2]} "} -> ${fnc[0]} -> {" ${fnc[1]} "}" >>relations
done

# Generate the .dot file
echo -e "
#
# This file is created through the execution of graph-game
# do not edit this file.
#
# Copyright (c) Matthew Peters, 2023
#
digraph {
    labelloc=t
    fontsize=20
    label="'"'"goJack State Machine Game Flow"'"'"" >state-diagram.dot


# de-dupe the states into the .dot file
cat states|sed "s/ /\n/g"|egrep -v "^$"|sort -u|sed "s/^/    /g"|sed "s/$/ \\[shape=\\\"parallelogram\\\"\\]/g">>state-diagram.dot
cat state-funcs >> state-diagram.dot
cat relations >> state-diagram.dot
echo "}" >>state-diagram.dot

# Generate the .png image
cat state-diagram.dot | dot -Tpng > images/game-states.png
